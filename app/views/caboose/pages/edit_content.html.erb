
<textarea id='page_<%= @page.id %>_content' placeholder='Content' style='width:595px; height:320px;' class='tinymce'>
  <%= raw @page.content %>
</textarea>
<br />
<div id='message'></div>
<div id='controls'>
<input type='button' value='Close' onclick="modal.close();" />
<input type='button' value='Update' onclick="updateContent();" />
</div>

<% content_for :caboose_js do %>

  <%= javascript_include_tag "caboose/model/all" %>
  <%= tinymce_assets %>

  <script type="text/javascript">

  var modal = false;
  $(document).ready(function() {  
    modal = new CabooseModal(600, 475);

    // Hack so that editor actually changes size
    // Couldn't get any of the official methods working...
    $("span[class='mce-text',value='Source code']").on('click', function() {
      $("div[aria-label='Source code']").next()
        .width(100).height(100);
    });
  });

  function updateContent()
  {
    tinymce.triggerSave();

    $.ajax({
      url: '/pages/<%= @page.id %>',
      type: 'put',
      data: {
        content: $('#page_<%= @page.id %>_content').val()
      },
      success: function(resp) {
        if (resp.success)
        {
          contentVal = $('#page_<%= @page.id %>_content').val();
          parent.$('#editmode_content_container').html(contentVal == null || contentVal.length == 0 ? 'No content.' : contentVal);
          modal.close();
        }
        if (resp.error)
          modal.autosize("<p class='note success'>" + resp.error + "</p>");
      }
    });
  }

  </script>
  <%= tinymce :caboose,
    width:'595px',
    height:'320px',
    theme_advanced_source_editor_width: '100px',
    theme_advanced_source_editor_height: '100px'
  %>
<% end %>
